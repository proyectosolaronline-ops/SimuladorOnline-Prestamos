<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Pr√©stamos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Notificador Admin */
        .admin-notification {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            display: none;
        }

        .admin-notification.active {
            display: block;
        }

        .admin-notification .message {
            font-weight: 500;
            line-height: 1.5;
        }

        .card {
            background: white;
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: white;
            font-size: 1.2rem;
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            text-align: center;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        select {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-family: 'Poppins', sans-serif;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Total Pr√©stamo */
        .total-prestamo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2.5rem 2rem;
            border-radius: 20px;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
        }

        .total-prestamo .label {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .total-prestamo .amount {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -2px;
        }

        /* Resultados */
        .resultados {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .resultado-item {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .resultado-item.full {
            grid-column: 1 / -1;
        }

        .resultado-item .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .resultado-item .label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .resultado-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        /* Bot√≥n Flotante WhatsApp */
        .whatsapp-float {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .whatsapp-btn {
            width: 70px;
            height: 70px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 2.5rem;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(37, 211, 102, 0.4);
            transition: all 0.3s;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 24px rgba(37, 211, 102, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 12px 32px rgba(37, 211, 102, 0.6);
            }
        }

        .whatsapp-btn:hover {
            background: #20BA5A;
            transform: scale(1.1);
        }

        @media (max-width: 640px) {
            body {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 1.5rem;
            }

            .total-prestamo .amount {
                font-size: 2.5rem;
            }

            .resultados {
                grid-template-columns: 1fr;
            }

            .whatsapp-float {
                bottom: 1.5rem;
                right: 1.5rem;
            }

            .whatsapp-btn {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Simulador de Pr√©stamos</h1>
            <p>Calcula tu pr√©stamo en tiempo real</p>
        </div>

        <!-- Notificador Admin -->
        <div id="admin-notification" class="admin-notification">
            <div class="message" id="admin-message"></div>
        </div>

        <div id="loading" class="loading">‚è≥ Cargando...</div>
        <div id="error" class="error" style="display:none;"></div>
        <div id="app" style="display:none;"></div>
    </div>

    <!-- Bot√≥n Flotante WhatsApp -->
    <div class="whatsapp-float">
        <button class="whatsapp-btn" id="whatsapp-btn" title="Solicitar por WhatsApp">üì±</button>
    </div>

    <script>
        // CONFIGURACI√ìN
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwkI-t5xxEHZWWAjR1zMk7YYMVmESzno5xpA14yA2FE0edEc1QMwjJzFRztvrrI22zL6w/exec';
        const WHATSAPP_NUMBER = '4424003376';

        // ESTADO
        let parametros = {};
        let capital = 0;
        let meses = 0;
        let interes = 0;

        // CARGAR DATOS
        async function inicializar() {
            try {
                // Cargar par√°metros
                const responseParametros = await fetch(APPS_SCRIPT_URL + '?tipo=parametros');
                const dataParametros = await responseParametros.json();
                
                console.log('‚úÖ Datos recibidos:', dataParametros);
                
                if (!dataParametros || dataParametros.length === 0) {
                    throw new Error('No se recibieron datos de la hoja Parametros');
                }
                
                // Organizar datos: parametros[capital][meses] = interes
                dataParametros.forEach(item => {
                    const cap = Number(item.capital);
                    const mes = Number(item.meses);
                    const int = Number(item.interes);
                    
                    if (!parametros[cap]) parametros[cap] = {};
                    parametros[cap][mes] = int;
                });
                
                console.log('‚úÖ Par√°metros organizados:', parametros);
                
                // Establecer valores iniciales
                const capitales = Object.keys(parametros).map(Number).sort((a,b) => a-b);
                capital = capitales[0];
                
                const mesesDisponibles = Object.keys(parametros[capital]).map(Number).sort((a,b) => a-b);
                meses = mesesDisponibles[0];
                
                interes = parametros[capital][meses];
                
                // Cargar configuraci√≥n admin
                await cargarAdmin();
                
                // Mostrar interfaz
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                renderizar();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Error al cargar datos: ' + error.message;
            }
        }

        async function cargarAdmin() {
            try {
                const response = await fetch(APPS_SCRIPT_URL + '?tipo=admin');
                const data = await response.json();
                
                if (data.activo && data.mensaje) {
                    document.getElementById('admin-message').textContent = data.mensaje;
                    document.getElementById('admin-notification').classList.add('active');
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è No hay configuraci√≥n de admin');
            }
        }

        // CALCULAR
        function calcular() {
            const tasaMensual = interes / 100;
            const totalInteres = capital * tasaMensual * meses;
            const totalPrestamo = capital + totalInteres;
            const diasPrestamo = meses * 30;
            const pagodiario = totalPrestamo / diasPrestamo;
            
            return {
                capital: capital,
                meses: meses,
                interes: interes,
                totalPrestamo: totalPrestamo,
                totalInteres: totalInteres,
                diasPrestamo: diasPrestamo,
                pagoDiario: pagodiario
            };
        }

        // RENDERIZAR
        function renderizar() {
            const capitales = Object.keys(parametros).map(Number).sort((a,b) => a-b);
            const mesesDisponibles = Object.keys(parametros[capital] || {}).map(Number).sort((a,b) => a-b);
            const resultado = calcular();

            const html = `
                <div class="card">
                    <!-- Capital -->
                    <div class="form-group">
                        <label>üíµ Capital</label>
                        <select id="capital-select">
                            ${capitales.map(c => `
                                <option value="${c}" ${c === capital ? 'selected' : ''}>
                                    $${c.toLocaleString('es-MX')}
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    <!-- Meses -->
                    <div class="form-group">
                        <label>üìÖ Meses</label>
                        <select id="meses-select">
                            ${mesesDisponibles.map(m => `
                                <option value="${m}" ${m === meses ? 'selected' : ''}>
                                    ${m} ${m === 1 ? 'mes' : 'meses'}
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    <!-- Inter√©s -->
                    <div class="form-group">
                        <label>üìä Inter√©s</label>
                        <select id="interes-select" disabled>
                            <option>${interes}% mensual</option>
                        </select>
                    </div>

                    <!-- TOTAL -->
                    <div class="total-prestamo">
                        <div class="label">üí∞ Total del Pr√©stamo</div>
                        <div class="amount">$${resultado.totalPrestamo.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>

                    <!-- RESULTADOS -->
                    <div class="resultados">
                        <div class="resultado-item full">
                            <div class="icon">üìÜ</div>
                            <div class="label">Pago por D√≠a</div>
                            <div class="value">$${resultado.pagoDiario.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>

                        <div class="resultado-item">
                            <div class="icon">‚è±Ô∏è</div>
                            <div class="label">D√≠as Totales</div>
                            <div class="value">${resultado.diasPrestamo}</div>
                        </div>

                        <div class="resultado-item">
                            <div class="icon">üíµ</div>
                            <div class="label">Capital</div>
                            <div class="value">$${resultado.capital.toLocaleString('es-MX')}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('app').innerHTML = html;
            
            // Event listeners
            document.getElementById('capital-select').addEventListener('change', alCambiarCapital);
            document.getElementById('meses-select').addEventListener('change', alCambiarMeses);
        }

        function alCambiarCapital(e) {
            capital = Number(e.target.value);
            
            // Actualizar meses disponibles
            const mesesDisponibles = Object.keys(parametros[capital]).map(Number).sort((a,b) => a-b);
            meses = mesesDisponibles[0];
            
            // Actualizar inter√©s
            interes = parametros[capital][meses];
            
            renderizar();
        }

        function alCambiarMeses(e) {
            meses = Number(e.target.value);
            interes = parametros[capital][meses];
            renderizar();
        }

        // WHATSAPP
        function enviarWhatsApp() {
            const resultado = calcular();
            
            const mensaje = `*SOLICITUD DE PR√âSTAMO*

üí∞ *Capital:* $${resultado.capital.toLocaleString('es-MX')}
üìÖ *Plazo:* ${resultado.meses} meses (${resultado.diasPrestamo} d√≠as)
üìä *Inter√©s:* ${resultado.interes}% mensual

*RESUMEN:*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíµ Total a Pagar: $${resultado.totalPrestamo.toLocaleString('es-MX', {minimumFractionDigits: 2})}
üìÜ Pago Diario: $${resultado.pagoDiario.toLocaleString('es-MX', {minimumFractionDigits: 2})}

Deseo solicitar este pr√©stamo.`;

            const url = `https://wa.me/52${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        document.getElementById('whatsapp-btn').addEventListener('click', enviarWhatsApp);

        // INICIAR
        inicializar();
    </script>
</body>
</html>
