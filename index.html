
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Pr√©stamos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            padding-bottom: 6rem;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Notificador Admin */
        .admin-notification {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            animation: slideDown 0.5s ease-out;
            display: none;
        }

        .admin-notification.active {
            display: block;
        }

        .admin-notification .icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        .admin-notification .message {
            font-weight: 500;
            line-height: 1.5;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: white;
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: white;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        /* Range Slider Personalizado */
        .range-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .range-value {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .range-value:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .range-value .amount {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .range-value .label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        select {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-family: 'Poppins', sans-serif;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Total Pr√©stamo Destacado */
        .total-prestamo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2.5rem 2rem;
            border-radius: 20px;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 12px 40px rgba(102, 126, 234, 0.6);
            }
        }

        .total-prestamo .label {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .total-prestamo .amount {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -2px;
            margin-bottom: 0.5rem;
            text-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .total-prestamo .subtitle {
            font-size: 0.95rem;
            opacity: 0.85;
        }

        /* Par√°metros Calculados en Tiempo Real */
        .parametros-calculados {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        .parametro-item {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .parametro-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .parametro-item .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .parametro-item .label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .parametro-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .parametro-item.full-width {
            grid-column: 1 / -1;
        }

        /* Bot√≥n Flotante WhatsApp */
        .whatsapp-float {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .whatsapp-btn {
            width: 70px;
            height: 70px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 2.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(37, 211, 102, 0.4);
            transition: all 0.3s ease;
            animation: bounce 2s infinite;
        }

        .whatsapp-btn:hover {
            background: #20BA5A;
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(37, 211, 102, 0.6);
        }

        .whatsapp-btn:active {
            transform: scale(0.95);
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .whatsapp-tooltip {
            position: absolute;
            right: 80px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            color: #333;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .whatsapp-float:hover .whatsapp-tooltip {
            opacity: 1;
        }

        .whatsapp-tooltip::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid white;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        @media (max-width: 640px) {
            body {
                padding: 1rem;
                padding-bottom: 6rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 1.5rem;
            }

            .range-value .amount {
                font-size: 2rem;
            }

            .total-prestamo .amount {
                font-size: 2.5rem;
            }

            .parametros-calculados {
                grid-template-columns: 1fr;
            }

            .whatsapp-float {
                bottom: 1.5rem;
                right: 1.5rem;
            }

            .whatsapp-btn {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }

            .whatsapp-tooltip {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Simulador de Pr√©stamos</h1>
            <p>Calcula tu pr√©stamo en tiempo real</p>
        </div>

        <!-- Notificador Admin -->
        <div id="admin-notification" class="admin-notification">
            <span class="icon">üì¢</span>
            <span class="message" id="admin-message"></span>
        </div>

        <div id="loading" class="loading">‚è≥ Cargando par√°metros...</div>
        <div id="app" style="display:none;"></div>
    </div>

    <!-- Bot√≥n Flotante WhatsApp -->
    <div class="whatsapp-float">
        <div class="whatsapp-tooltip">¬°Solicita tu pr√©stamo!</div>
        <button class="whatsapp-btn" id="whatsapp-float-btn" title="Solicitar por WhatsApp">
            üì±
        </button>
    </div>

    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwkI-t5xxEHZWWAjR1zMk7YYMVmESzno5xpA14yA2FE0edEc1QMwjJzFRztvrrI22zL6w/exec';
        const WHATSAPP_NUMBER = '4424003376';

        let parametros = null;
        let adminConfig = null;
        let capital = 5000;
        let meses = 3;
        let interes = 0;

        // Rangos para el slider de capital
        let minCapital = 1000;
        let maxCapital = 50000;
        let stepCapital = 500;

        async function cargarParametros() {
            try {
                // Cargar par√°metros desde Apps Script
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL + '?tipo=parametros');
                const data = await response.json();
                
                console.log('Datos recibidos del Apps Script:', data);
                
                parametros = {};
                
                // Los datos vienen como: [{interes, meses, capital}, ...]
                data.forEach(item => {
                    const capitalVal = parseFloat(item.capital);
                    const mesesVal = parseInt(item.meses);
                    const interesVal = parseFloat(item.interes);
                    
                    if (!parametros[capitalVal]) parametros[capitalVal] = {};
                    parametros[capitalVal][mesesVal] = interesVal;
                });
                
                console.log('Par√°metros procesados:', parametros);

                // Cargar configuraci√≥n de administrador
                await cargarConfigAdmin();
                
                const capitales = Object.keys(parametros).map(Number).sort((a,b) => a-b);
                if (capitales.length > 0) {
                    minCapital = capitales[0];
                    maxCapital = capitales[capitales.length - 1];
                    capital = capitales[0];
                }
                
                const mesesDisponibles = Object.keys(parametros[capital] || {}).map(Number).sort((a,b) => a-b);
                meses = mesesDisponibles[0] || 3;
                interes = parametros[capital]?.[meses] || 0;
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                render();
            } catch (err) {
                console.error('Error:', err);
                // Valores por defecto
                parametros = {
                    5000: { 3: 16, 6: 20, 9: 12 },
                    10000: { 3: 16, 6: 20, 9: 12, 12: 10 },
                    15000: { 3: 16, 6: 20, 9: 12, 12: 10 },
                    20000: { 3: 16, 6: 20, 9: 12, 12: 10 }
                };
                capital = 5000;
                meses = 3;
                interes = 16;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                render();
            }
        }

        async function cargarConfigAdmin() {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL + '?tipo=admin');
                const data = await response.json();
                
                adminConfig = {
                    activo: data.activo,
                    mensaje: data.mensaje
                };
                
                mostrarNotificacionAdmin();
            } catch (err) {
                console.log('No se pudo cargar configuraci√≥n de admin:', err);
            }
        }

        function mostrarNotificacionAdmin() {
            const notification = document.getElementById('admin-notification');
            const messageElement = document.getElementById('admin-message');
            
            if (adminConfig && adminConfig.activo && adminConfig.mensaje) {
                messageElement.textContent = adminConfig.mensaje;
                notification.classList.add('active');
            } else {
                notification.classList.remove('active');
            }
        }

        function obtenerCapitalMasCercano(valor) {
            const capitalesDisponibles = Object.keys(parametros).map(Number).sort((a,b) => a-b);
            
            // Encontrar el capital m√°s cercano
            let cercano = capitalesDisponibles[0];
            let menorDiferencia = Math.abs(valor - cercano);
            
            capitalesDisponibles.forEach(c => {
                const diferencia = Math.abs(valor - c);
                if (diferencia < menorDiferencia) {
                    menorDiferencia = diferencia;
                    cercano = c;
                }
            });
            
            return cercano;
        }

        function calcularPrestamo() {
            const tasaMensual = interes / 100;
            const totalInteres = capital * tasaMensual * meses;
            const totalPrestamo = capital + totalInteres;
            const diasPrestamo = meses * 30;
            const totalPorDia = totalPrestamo / diasPrestamo;

            return {
                capital: capital,
                meses: meses,
                interes: interes,
                totalPorDia: totalPorDia.toFixed(2),
                diasPrestamo: diasPrestamo,
                totalCapital: capital.toFixed(2),
                totalPrestamo: totalPrestamo.toFixed(2),
                totalInteres: totalInteres.toFixed(2)
            };
        }

        function enviarWhatsApp() {
            const resultado = calcularPrestamo();
            
            const mensaje = `*SOLICITUD DE PR√âSTAMO*

üí∞ *Capital Solicitado:* $${parseFloat(resultado.totalCapital).toLocaleString('es-MX')}
üìÖ *Plazo:* ${resultado.meses} meses (${resultado.diasPrestamo} d√≠as)
üìä *Tasa de Inter√©s:* ${interes}%

*DESGLOSE DEL PR√âSTAMO:*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíµ Total a Pagar: $${parseFloat(resultado.totalPrestamo).toLocaleString('es-MX')}
üìà Inter√©s Total: $${parseFloat(resultado.totalInteres).toLocaleString('es-MX')}
üìÜ Pago Diario: $${parseFloat(resultado.totalPorDia).toLocaleString('es-MX')}

Deseo solicitar este pr√©stamo.`;

            const url = `https://wa.me/52${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        function onCapitalSliderChange(e) {
            const valor = Number(e.target.value);
            capital = obtenerCapitalMasCercano(valor);
            
            const mesesDisponibles = Object.keys(parametros[capital] || {}).map(Number).sort((a,b) => a-b);
            
            // Mantener los meses actuales si est√°n disponibles, sino usar el primero
            if (!mesesDisponibles.includes(meses)) {
                meses = mesesDisponibles[0] || 3;
            }
            
            interes = parametros[capital]?.[meses] || 0;
            render();
        }

        function onMesesChange(e) {
            meses = Number(e.target.value);
            interes = parametros[capital]?.[meses] || 0;
            render();
        }

        function render() {
            const capitalesDisponibles = Object.keys(parametros).map(Number).sort((a,b) => a-b);
            const mesesDisponibles = parametros[capital] ? Object.keys(parametros[capital]).map(Number).sort((a,b) => a-b) : [];
            const resultado = calcularPrestamo();

            const html = `
                <div class="card">
                    <!-- SELECTOR 1: CAPITAL -->
                    <div class="form-group">
                        <label>üíµ Capital</label>
                        <select id="capital-select">
                            ${capitalesDisponibles.map(c => `
                                <option value="${c}" ${c === capital ? 'selected' : ''}>
                                    $${c.toLocaleString('es-MX')}
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    <!-- SELECTOR 2: MESES -->
                    <div class="form-group">
                        <label>üìÖ Meses</label>
                        <select id="meses-select">
                            ${mesesDisponibles.map(m => `
                                <option value="${m}" ${m === meses ? 'selected' : ''}>
                                    ${m} ${m === 1 ? 'mes' : 'meses'}
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    <!-- SELECTOR 3: INTER√âS -->
                    <div class="form-group">
                        <label>üìä Inter√©s (%)</label>
                        <select id="interes-select">
                            ${mesesDisponibles.map(m => {
                                const interesParaMes = parametros[capital]?.[m] || 0;
                                return `<option value="${m}" ${m === meses ? 'selected' : ''}>${interesParaMes}%</option>`;
                            }).join('')}
                        </select>
                    </div>

                    <!-- TOTAL PR√âSTAMO DESTACADO -->
                    <div class="total-prestamo">
                        <div class="label">üí∞ Total del Pr√©stamo</div>
                        <div class="amount">$${parseFloat(resultado.totalPrestamo).toLocaleString('es-MX')}</div>
                    </div>

                    <!-- RESULTADOS EN TIEMPO REAL -->
                    <div class="parametros-calculados">
                        <div class="parametro-item full-width">
                            <span class="icon">üìÜ</span>
                            <div class="label">Pago por D√≠a</div>
                            <div class="value">$${parseFloat(resultado.totalPorDia).toLocaleString('es-MX')}</div>
                        </div>

                        <div class="parametro-item">
                            <span class="icon">‚è±Ô∏è</span>
                            <div class="label">D√≠as Totales</div>
                            <div class="value">${resultado.diasPrestamo}</div>
                        </div>

                        <div class="parametro-item">
                            <span class="icon">üíµ</span>
                            <div class="label">Capital</div>
                            <div class="value">$${parseFloat(resultado.totalCapital).toLocaleString('es-MX')}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('app').innerHTML = html;
            
            // Event listeners
            document.getElementById('capital-select').addEventListener('change', onCapitalChange);
            document.getElementById('meses-select').addEventListener('change', onMesesChange);
            document.getElementById('interes-select').addEventListener('change', onMesesChange);
        }

        function onCapitalChange(e) {
            capital = Number(e.target.value);
            const mesesDisponibles = Object.keys(parametros[capital] || {}).map(Number).sort((a,b) => a-b);
            meses = mesesDisponibles[0] || 3;
            interes = parametros[capital]?.[meses] || 0;
            render();
        }

        // Event listener para bot√≥n flotante de WhatsApp
        document.getElementById('whatsapp-float-btn').addEventListener('click', enviarWhatsApp);

        // Inicializar
        cargarParametros();
    </script>
</body>
</html>
